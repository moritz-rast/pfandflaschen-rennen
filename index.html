<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Pfandflaschen-Rennen</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{--start-left:120px}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#fff}

    .himmel{background:#87CEEB;height:270px;text-align:center;padding-top:20px}
    .headline{color:#444;font-size:8vw;font-weight:700;margin-bottom:20px}

    .textfeld{background:#f9f1dc;border-radius:10px;padding:12px 24px;margin:12px auto;width:fit-content;box-shadow:0 2px 5px rgba(0,0,0,.2);font-size:clamp(16px,3.5vw,22px);font-weight:600}

    .gras1{background:#63c066;height:35px}
    .gras2{background:#51aa54;height:10px}

    .strecke{position:relative;display:block}
    .bahnoben{height:35px}

    .bahn{height:53px;display:flex;align-items:center;justify-content:flex-start;font-weight:700;color:#fff;font-size:20px;padding-left:10px;box-sizing:border-box}
    .bahn span{width:100px;text-align:center;flex-shrink:0}

    .beige{background:#ead4ac;color:#333}
    .grau{background:#5e5c5c}

    .flagge{position:absolute;top:38px;right:85px;width:40px;height:368px;background-color:#ededed;background-image:linear-gradient(45deg,#272727 25%,transparent 25%,transparent 75%,#272727 75%,#000),linear-gradient(45deg,#272727 25%,transparent 25%,transparent 75%,#272727 75%,#000);background-size:40px 40px;background-position:0 0,20px 20px;pointer-events:none;z-index:1}
    #manual-flag{position:absolute;top:-50px;right:5px;width:110px;transform:rotate(13deg);pointer-events:none;z-index:1}

    /* Autos werden absolut in .strecke positioniert (oben/left in px) */
    .auto{position:absolute;left:var(--start-left);width:80px;height:auto;transition:left 800ms ease, transform 300ms ease;z-index:3}

    .login{margin:20px;text-align:center}
    .login button{background:#63c066;color:#fff;border:0;padding:10px 20px;margin:5px;border-radius:8px;font-size:16px;cursor:pointer;box-shadow:0 2px 5px rgba(0,0,0,.2)}
    .login button:hover{background:#51aa54}
    .hidden{display:none}

    @media (max-width:600px){.headline{font-size:10vw}.textfeld{font-size:16px}}

      /* --- Mobile Ansicht optimieren --- */
    @media (max-width: 600px) {
      :root {
        --start-left: 60px; /* Autos starten weiter links */
      }

    .bahn span {
      width: 60px;       /* Klassennamen schmaler */
      font-size: 14px;   /* kleinere Schrift */
      text-align: left;  /* mehr Platz rechts f√ºr Autos */
      padding-left: 5px;
    }

    .flagge{
      position:absolute;
      top:38px;
      right:7px;
      width:40px;
      height:368px;
      background-color:#ededed;
      background-image:linear-gradient(45deg,#272727 25%,transparent 25%,transparent 75%,#272727 75%,#000),linear-gradient(45deg,#272727 25%,transparent 25%,transparent 75%,#272727 75%,#000);
      background-size:40px 40px;background-position:0 0,20px 20px;pointer-events:none;z-index:1
    } 
  
    #manual-flag{
      position:absolute;top:-30px;
      right:0px;width:90px;
      transform:rotate(13deg);
      pointer-events:none;z-index:1
    }

    .auto {
      width: 60px;       /* Autos etwas kleiner */
    }
  }


    
  </style>
</head>
<body>
  <div class="himmel">
    <div class="headline">Pfandflaschen‚ÄëRennen</div>
    <div class="textfeld" id="gesamt">Gesamtanzahl der gesammelten Flaschen: 0</div>
    <div class="textfeld" id="sieger"></div>
  </div>

  <div class="gras1"></div>
  <div class="gras2"></div>

  <div class="strecke" id="rennen">
    <div class="bahnoben beige"></div>

    <div class="bahn grau" data-klasse="SH4"><span>SH4</span></div>
    <div class="bahn beige" data-klasse="SH3"><span>SH3</span></div>
    <div class="bahn grau" data-klasse="SH2"><span>SH2</span></div>
    <div class="bahn beige" data-klasse="SH1-A"><span>SH1-A</span></div>
    <div class="bahn grau" data-klasse="SH1-B"><span>SH1-B</span></div>
    <div class="bahn beige" data-klasse="JH4-A"><span>JH4-A</span></div>
    <div class="bahn grau" data-klasse="JH4-B"><span>JH4-B</span></div>

    <div class="bahnoben beige"></div>

    <div class="flagge"></div>
    <img id="manual-flag" src="flag.png" alt="Deine Flagge">

    <!-- Autos: liegen in .strecke (oben/left werden per JS gesetzt) -->
    <img id="auto-SH4" class="auto" src="auto1.png" alt="SH4">
    <img id="auto-SH3" class="auto" src="auto2.png" alt="SH3">
    <img id="auto-SH2" class="auto" src="auto3.png" alt="SH2">
    <img id="auto-SH1-A" class="auto" src="auto4.png" alt="SH1-A">
    <img id="auto-SH1-B" class="auto" src="auto5.png" alt="SH1-B">
    <img id="auto-JH4-A" class="auto" src="auto6.png" alt="JH4-A">
    <img id="auto-JH4-B" class="auto" src="auto7.png" alt="JH4-B">
  </div>

  <div class="login">
    <a href="/admin/" style="text-decoration:none"><button>Admin (Netlify CMS)</button></a>
  </div>

  <script>
    // --- Konfiguration ---
    const DATA_FILE = 'scores.json';
    const POLL_MS = 2500; // wie oft die JSON neu geladen wird
    const ZIEL = 400;

    // Klassengr√∂√üen (Beispielzahlen, bitte anpassen!)
    const KLASSE_GROESSEN = {
      "SH4": 14,
      "SH3": 25,
      "SH2": 17,
      "SH1-A": 16,
      "SH1-B": 16,
      "JH4-A": 14,
      "JH4-B": 13
    };


    // l√§dt die JSON (bypass cache) und ruft updateUI
    async function fetchScores(){
      try{
        const res = await fetch(DATA_FILE + '?ts=' + Date.now(), {cache: 'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const json = await res.json();
        return json;
      }catch(e){
        console.warn('Fehler beim Laden von', DATA_FILE, e);
        return null;
      }
    }

    async function updateUI(){
      const data = await fetchScores();
      if(!data) return;

      const scores = data.scores || {};
      const gesamt = data.gesamt || 0;
      document.getElementById('gesamt').innerText = 'Gesamtanzahl der gesammelten Flaschen: ' + gesamt;

      const container = document.getElementById('rennen');
      const containerRect = container.getBoundingClientRect();
      const flag = document.querySelector('.flagge');
      const flagRect = flag.getBoundingClientRect();

      // Ziel-Koordinate (rechte Kante, so dass Auto bis zur Flagge f√§hrt)
      const endX = flagRect.left - containerRect.left - 8; // px
      const startX = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--start-left')) || 120;

      let sieger = '';

      // f√ºr jede Klasse im JSON
      for(const klasse in scores){
        const rawValue = scores[klasse] || 0;
        const size = KLASSE_GROESSEN[klasse] || 1; 
        const value = rawValue / size * 100; // Prozentwert

        const auto = document.getElementById('auto-' + klasse);
        const lane = document.querySelector('.bahn[data-klasse="' + klasse + '"]');
        if(!auto || !lane) continue;

        const laneRect = lane.getBoundingClientRect();
        const carRect = auto.getBoundingClientRect();
        const carW = carRect.width || 60;
        const carH = carRect.height || 40;

      // top Position
      const top = (laneRect.top - containerRect.top) + (laneRect.height - carH)/2;
      auto.style.top = Math.round(top) + 'px';

      // Links berechnen
      const proportion = Math.min(value / ZIEL, 1);
      const maxLeft = endX - carW;
      const leftPx = Math.round(startX + proportion * (maxLeft - startX));
      auto.style.left = leftPx + 'px';

      if(value >= ZIEL && !sieger) sieger = klasse;
    }


      document.getElementById('sieger').innerText = sieger ? 'üèÜ ' + sieger + ' hat gewonnen!' : '';
    }

    // Polling starten
    updateUI();
    setInterval(updateUI, POLL_MS);

    // auch bei resize neu positionieren
    window.addEventListener('resize', updateUI);
  </script>
</body>
</html>
